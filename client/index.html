<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Teamcrypt App</title>

        <link rel="stylesheet" href="https://getnucleon.com/release/latest/nucleon.min.css">
        <link rel="stylesheet" href="./dist/main.bundle.css">

        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

        <script src="./dist/main.min.js"></script>

        <style>
            .full-width { max-width: none }
        </style>
    </head>
    <body>
        <div id="vue-app" class="container full-width px-4">
            <div class="row">
                <div class="col-4">
                    <div class="add-entry vue">
                        <form @submit.prevent="formSubmit">
                            <h3 class="text-center">Vue Add Entry</h3>

                            <div class="row">
                                <div class="col-12">
                                    <label for="v-type">Type</label>
                                    <select id="v-type" v-model="type">
                                        <option value="entry" selected>Entry</option>
                                        <option value="folder">Folder</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="v-title">Title</label>
                                    <input id="v-title" v-model="title" type="text">
                                </div>
                                <div class="col-12">
                                    <label for="v-parent">Parent</label>
                                    <input id="v-parent" v-model="parent" type="text">
                                </div>
                                <div v-if="type === 'entry'" class="col-12">
                                    <label for="v-username">Username</label>
                                    <input id="v-username" v-model="username" type="text">
                                </div>
                                <div v-if="type === 'entry'" class="col-6">
                                    <label for="v-password">Password</label>
                                    <input id="v-password" v-model="password" type="password">
                                </div>
                                <div v-if="type === 'entry'" class="col-6">
                                    <label for="v-confirm-password">Confirm Password</label>
                                    <input id="v-confirm-password" v-model="confirmPassword" type="password">
                                </div>
                                <div v-if="type === 'entry'" class="col-12">
                                    <label for="v-url">URL</label>
                                    <input id="v-url" v-model="url" type="text">
                                </div>
                                <div v-if="type === 'entry'" class="col-12">
                                    <label for="v-notes">Notes</label>
                                    <textarea id="v-notes" v-model="notes" rows="6"></textarea>
                                </div>
                                <div class="col-6 col-offset-3">
                                    <button class="submit btn btn-block btn-primary">Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-4">
                    <h3 class="text-center">Keyfile Methods</h3>
                    <div class="row">
                        <div class="col-6 mb-0 pb-0">
                            <label for="v-passphrase">Passphrase</label>
                            <input id="v-passphrase" type="text" v-model="passphrase">
                        </div>
                        <div class="col-6 mb-0 pb-0">
                            <label for="v-salt">Salt</label>
                            <input id="v-salt" type="text" v-model="salt">
                        </div>
                        <div class="col-12 mt-0 pt-0">
                            <button @click="setKey" class="btn btn-block btn-primary mx-0">Set Key</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-0 pb-0">
                            <button @click="encrypt" class="btn btn-block btn-danger">Encrypt</button>
                        </div>
                        <div class="col-6 mb-0 pb-0">
                            <button @click="decrypt" class="btn btn-block btn-success">Decrypt</button>
                        </div>
                    </div>
                </div>

                <div class="col-4 pt-5">
                    <h3>Keyfile Data</h3>
                    <pre><code>{{ output }}</code></pre>

                    <h3>Tree View</h3>
                    <pre><code>{{ JSON.stringify(tree, null, 4) }}</code></pre>
                </div>
            </div>
        </div>


        <script>
            'use strict';

            (function() {

                const kf = new Keyfile();

                const viewModel = new Vue({
                    el: '#vue-app',
                    data(){
                        return {
                            type:            'entry',
                            title:           '',
                            parent:          '',
                            username:        '',
                            password:        '',
                            confirmPassword: '',
                            url:             '',
                            notes:           '',
                            passphrase:      '',
                            salt:            '',
                            output:          '',
                            tree:            []
                        }
                    },
                    methods: {
                        formSubmit(e){
                            kf.add({
                                type:            this.type,
                                title:           this.title,
                                parent:          this.parent,
                                username:        this.username,
                                password:        this.password,
                                confirmPassword: this.confirmPassword,
                                url:             this.url,
                                notes:           this.notes
                            });

                            this.output = kf.keyfile;
                            this.tree   = kf.toTree();

                            this.reset();
                        },
                        setKey(e){
                            kf.setKey(this.passphrase, crypt.hex2ab(this.salt));
                        },
                        encrypt: async function(){
                            try{
                                await kf.encrypt();

                                this.output = kf.keyfile;
                                this.tree   = null;
                            }
                            catch(e){
                                console.error(e);
                            }
                        },
                        decrypt: async function(){
                            try{
                                await kf.decrypt();

                                this.output = JSON.stringify(kf.keyfile, null, 4);
                                this.tree   = kf.toTree();
                            }
                            catch(e){
                                console.error(e);
                            }
                        },
                        reset(){
                            this.title           = '';
                            this.parent          = '';
                            this.username        = '';
                            this.password        = '';
                            this.confirmPassword = '';
                            this.url             = '';
                            this.notes           = '';
                        }
                    },
                    mounted(){
                        const salt = crypt.genSalt();

                        this.salt = crypt.ab2hex(salt);

                        this.output = JSON.stringify(kf.keyfile, null, 4);
                    }
                });

            }());
        </script>
    </body>
</html>
